{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{page_title}}{% endblock page_title %}

{% block custom_css %}
<style>
    .invalid{
      font-style: italic;
      font-weight: bold;
      color: red;
    }
    .valid{
      font-style: italic;
      font-weight: bold;
      color: green;
    }
    .password-wrapper {
      position: relative;
      display: inline-block;
    }
    .password-wrapper button {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
    }
</style>
{% endblock custom_css %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card card-dark">
                    <div class="card-header">
                        <h3 class="card-title">{{page_title}}</h3>
                    </div>

                    {% include "main_app/form_template.html" with messages=messages  form=form button_text="Add Staff"%}
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block custom_js %}
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
/>

<script>
function validateEmail(email) {
    const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return re.test(String(email).toLowerCase());
}

$(document).ready(function () {
    const addBtn = $("button[type='submit']");
    addBtn.hide();

    const passwordField = $("#id_password");
    if (passwordField.length) {
        passwordField.wrap('<div class="password-wrapper"></div>');
        passwordField.after(`
            <button type="button" id="togglePassword">
                <i class="fas fa-eye"></i>
            </button>
        `);

        $(document).on("click", "#togglePassword", function () {
            const inputType = passwordField.attr("type");
            const icon = $(this).find("i");
            if (inputType === "password") {
                passwordField.attr("type", "text");
                icon.removeClass("fa-eye").addClass("fa-eye-slash");
            } else {
                passwordField.attr("type", "password");
                icon.removeClass("fa-eye-slash").addClass("fa-eye");
            }
        });
    }

    function checkFormCompletion() {
        let isValid = true;
        const requiredFields = [
            "#id_first_name",
            "#id_last_name",
            "#id_address",
            "#id_school",
            "#id_email",
            "#id_gender",
            "#id_password",
            "#id_course",
            "#id_profile_pic"
        ];

        requiredFields.forEach(function (selector) {
            const value = $(selector).val();
            if (!value || value.trim() === "") {
                isValid = false;
            }
        });

        const emailVal = $("#id_email").val();
        if (!validateEmail(emailVal)) {
            isValid = false;
        }

        if (isValid) {
            addBtn.fadeIn();
        } else {
            addBtn.fadeOut();
        }
    }

    $("input, select").on("input change", checkFormCompletion);

    $("#id_email").keyup(function () {
        var email = $(this).val();
        if (validateEmail(email)) {
            $.ajax({
                url: "{% url 'check_email_availability' %}",
                type: 'POST',
                data: {email: email},
            }).done(function(response){
                $(".email_error").remove();
                if (response == "True") {
                    $("<span class='invalid email_error'>Email Address Already Exist</span>").insertAfter("#id_email");
                } else {
                    $("<span class='valid email_error'>Email Address Available</span>").insertAfter("#id_email");
                }
                checkFormCompletion();
            }).fail(function(){
                $("<span class='alert alert-warning'>Server Could Not Process This</span>").insertAfter("#id_email");
            });
        }
    });

    checkFormCompletion(); // initial check
});
</script>
{% endblock custom_js %}
