{% extends 'main_app/base.html' %}
{% load static %}

{% block page_title %}{{ page_title }}{% endblock page_title %}

{% block custom_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .select2-container {
        width: 100% !important;
    }

    .invalid {
        font-style: italic;
        font-weight: bold;
        color: red;
    }

    .valid {
        font-style: italic;
        font-weight: bold;
        color: green;
    }

    .is-invalid {
        border: 2px solid red !important;
    }
</style>
{% endblock custom_css %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card card-dark">
                    <div class="card-header">
                        <h3 class="card-title">{{ page_title }}</h3>
                    </div>

                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="card-body">
                            <div class="form-group">
                                <label for="first_name">First Name</label>
                                <input type="text" name="first_name" class="form-control" id="first_name" required>
                            </div>
                            <div class="form-group">
                                <label for="last_name">Last Name</label>
                                <input type="text" name="last_name" class="form-control" id="last_name" required>
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" name="email" class="form-control" id="email" required>
                            </div>
                            <div class="form-group">
                                <label for="gender">Gender</label>
                                <select name="gender" class="form-control" id="gender" required>
                                    <option value="">Select Gender</option>
                                    <option value="M">Male</option>
                                    <option value="F">Female</option>
                                    <option value="O">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="password">Password</label>
                                <input type="password" name="password" class="form-control" id="password" required>
                            </div>
                            <div class="form-group">
                                <label for="address">Address</label>
                                <input type="text" name="address" class="form-control" id="address">
                            </div>
                            <div class="form-group">
                                <label for="profile_pic">Profile Picture</label>
                                <input type="file" name="profile_pic" class="form-control" id="profile_pic">
                            </div>

                            <!-- Search Bar for Students -->
                            <div class="search-dropdown" id="searchDropdown">
                                <div class="input-group">
                                    <input
                                        type="text"
                                        name="q"
                                        id="id_q"
                                        class="form-control"
                                        placeholder="Search for students..."
                                    />
                                    <button class="btn btn-outline-success" type="button" id="searchButton">
                                        <i class="fas fa-search"></i> Search
                                    </button>
                                </div>
                                <div id="studentsResults" class="dropdown-menu" style="display: none;"></div>
                            </div>

                            <!-- Selected Students Display -->
                            <div id="selectedStudentsList" style="margin-top: 10px;">
                                <strong>Selected Students:</strong>
                                <ul id="studentList"></ul>
                            </div>

                            <!-- Hidden input to store selected student IDs -->
                            <input type="hidden" name="students" id="students" value="">
                        </div>

                        <div class="card-footer">
                            <button type="submit" id="submitBtn" class="btn btn-primary">Add Parent</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block custom_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/js/select2.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("id_q");
    const searchButton = document.getElementById("searchButton");
    const studentsResults = document.getElementById("studentsResults");
    const studentList = document.getElementById("studentList");
    const hiddenStudentInput = document.getElementById("students");
    const form = document.querySelector("form");
    const submitBtn = document.getElementById("submitBtn");

    let selectedStudents = [];

    // Fetch students dynamically
    function fetchStudents(query) {
        fetch(`/search_students/?q=${encodeURIComponent(query)}`, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
        })
        .then((response) => response.json())
        .then((data) => {
            studentsResults.innerHTML = "";
            if (data.length > 0) {
                data.forEach((student) => {
                    const div = document.createElement("div");
                    div.classList.add("dropdown-item");
                    div.textContent = student.name;
                    div.setAttribute("data-id", student.id);

                    div.addEventListener("click", function () {
                        const studentId = div.getAttribute("data-id");
                        const studentName = div.textContent;

                        if (!selectedStudents.some(s => s.id === studentId)) {
                            selectedStudents.push({ id: studentId, name: studentName });
                            updateStudentList();
                        }

                        searchInput.value = '';
                        studentsResults.style.display = "none";
                        validateForm();
                    });

                    studentsResults.appendChild(div);
                });
                studentsResults.style.display = "block";
            } else {
                studentsResults.innerHTML = "<div class='dropdown-item'>No students found</div>";
                studentsResults.style.display = "block";
            }
        })
        .catch((error) => console.error("Error fetching students:", error));
    }

    // Update selected student list
    function updateStudentList() {
        studentList.innerHTML = "";
        selectedStudents.forEach(student => {
            const li = document.createElement("li");
            li.textContent = student.name;

            const removeButton = document.createElement("button");
            removeButton.textContent = "Remove";
            removeButton.classList.add("btn", "btn-sm", "btn-danger", "ml-2");
            removeButton.addEventListener("click", function () {
                selectedStudents = selectedStudents.filter(s => s.id !== student.id);
                updateStudentList();
                validateForm();
            });

            li.appendChild(removeButton);
            studentList.appendChild(li);
        });

        hiddenStudentInput.value = selectedStudents.map(s => s.id).join(',');
    }

    // Search functionality
    searchButton.addEventListener("click", function () {
        const query = searchInput.value.trim();
        if (query.length > 0) {
            fetchStudents(query);
        } else {
            studentsResults.style.display = "none";
        }
    });

    searchInput.addEventListener("keyup", function () {
        const query = searchInput.value.trim();
        if (query.length > 0) {
            fetchStudents(query);
        } else {
            studentsResults.style.display = "none";
        }
    });

    // Validation
    const requiredFields = ["first_name", "last_name", "email", "gender", "password"];

    function validateForm() {
        let allFilled = true;

        requiredFields.forEach(id => {
            const field = document.getElementById(id);
            if (!field || field.value.trim() === "") {
                field.classList.add("is-invalid");
                allFilled = false;
            } else {
                field.classList.remove("is-invalid");
            }
        });

        if (!hiddenStudentInput.value.trim()) {
            allFilled = false;
        }

        submitBtn.disabled = !allFilled;
    }

    form.addEventListener("input", validateForm);
    validateForm(); // Initial check
});
</script>
{% endblock custom_js %}
